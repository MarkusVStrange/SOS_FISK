diffVBGR_k <- D(VbgrF,"k")
diffVBGR_Linf <- D(VbgrF,"Linf")
diffVBGR_age <- D(VbgrF,"age")
cohorts <- sort(unique(cohort[haul.id!="larvae"]))
ret <- 0
for(i in 1:length(cohorts)){
cohort.idx <- which(cohort==cohorts[i] | haul.id=="larvae")
times.i <- sort(unique(t[cohort.idx]))
#if(i>1){
#  ret <- ret-dnorm(log(L1[i]),mean=log(L1[i-1]),sd=RWSD,log=TRUE)
#  ret <- ret-dnorm(log(L2[i]),mean=log(L2[i-1]),sd=RWSD,log=TRUE)
#  ret <- ret-dnorm(log(L3[i]),mean=log(L3[i-1]),sd=RWSD,log=TRUE)
#}
for(j in 1:length(times.i)){
age.idx <- which((t[cohort.idx])==times.i[j])
mean_idx <- which(t_mean==times.i[j] & cohort_mean==cohorts[i])
#if(length(age.idx)<2) next
age.j <- times.i[j]-t_hatch
phi_t.j <- u*sin(2*pi*(times.i[j]-w))/(2*pi) # seasonal variability in growth
mean_size <- L_mean[mean_idx]
weight <- HLNoAtLngt[cohort.idx][age.idx]/sqrt(sum((HLNoAtLngt[cohort.idx][age.idx])))
weight_m <- sqrt(n_mean[mean_idx])
dL_dk <- eval(diffVBGR_k,list(age=age.j,k=k[i],Linf=Linf[i],
phi_t =phi_t.j))
dL_dLinf <- eval(diffVBGR_Linf,list(age=age.j,k=k[i],Linf=Linf[i],
phi_t =phi_t.j))
dL_dage <- eval(diffVBGR_age,list(age=age.j,k=k[i],Linf=Linf[i],
phi_t =phi_t.j))
L.pred <- eval(VbgrF,list(age=age.j,k=k[i],Linf=Linf[i],
phi_t =phi_t.j))
#LSD <- sqrt((SD_k*dL_dk)^2+(SD_Linf*dL_dLinf)^2+(SDage*dL_dage)^2)
#ret <- ret-sum(dnorm(Length[cohort.idx][age.idx],
#                       mean=mean_size,sd=LSD,
#                       log=TRUE)*weight)
ret <- ret-dnorm(mean_size,mean=L.pred,sd=SD_m,log=TRUE)*weight_m # fit mean length
}
#logL.Hatch <- eval(logVbgrF,list(t=tHatch,L1=L1[i],L2=L2[i],L3=L3[i],t1=t1,t3=t3))
#ret <- ret-dnorm(logL.Hatch,log(0.4),SD_m)
}
x <- (0:1000)/100
c <- which(cohorts==2000)
phi_t.j <- u*sin(2*pi*(x-w))/(2*pi) # seasonal variability in growth
logfit <- (eval(VbgrF,list(age=x-t_hatch,k=k[i],Linf=Linf[i],
phi_t =phi_t.j)))
ADREPORT(logfit)
#dLdSpawn <- eval(diffVBGR,list(t=x,L1=L1,L2=L2,L3=L3,t1=t1,t3=t3))
#LogLSD <- sqrt(SD_c^2+(SDspawn*dLdSpawn)^2)
#ADREPORT(LogLSD)
L_mean <- OBS(L_mean)
t_mean <- OBS(t_mean)
cohort_mean <- OBS(cohort_mean)
n_mean <- OBS(n_mean)
#Length <- OBS(Length)
#HLNoAtLngt <- OBS(HLNoAtLngt)
#t <- OBS(t)
#cohort <- OBS(cohort)
ret
}
obj <- MakeADFun(f,par,silent=TRUE)
opt <- nlminb(obj$par, obj$fn, obj$gr)
sdr <- sdreport(obj)
sdr
res <- oneStepPredict(obj)
head(res)
# model growth functions
#####
ca_cod <- ca_cod %>% filter(Age<=10) # Remove an outliers
ca_cod$t <- ca_cod$Age+ca_cod$qday
ca_cod$Length <- exp(ca_cod$logLength)
df_m <- data.frame(t_mean = rep(ca_cod$t,times=round(ca_cod$HLNoAtLngt)),
L_mean = rep(ca_cod$Length,times=round(ca_cod$HLNoAtLngt)),
cohort_mean = rep(ca_cod$cohort,times=round(ca_cod$HLNoAtLngt)),
n_mean = 1)
df_mean <- aggregate(L_mean~t_mean+cohort_mean,data=df_m %>% filter(cohort_mean==2001),FUN=mean)
df_mean$n_mean <- aggregate(n_mean~t_mean+cohort_mean,data=df_m %>% filter(cohort_mean==2001),FUN=sum)$n_mean
#%>% filter(Age>0))
#rm(list=setdiff(ls(),c('par','dat')))
dat <- as.list(df_mean)
dat
par <- list()
par$logK.1 <- log(0.3)
par$logLinf.1 <- log(70)
par$logSD_m <- -1 # deviation from mean fit
table(dat$cohort_mean)
getAll(par,dat)
k <- c(exp(logK.1))#,exp(logK.rand))
Linf <- c(exp(logLinf.1))#,exp(logLinf.rand))
SD_m <- exp(logSD_m)
u <- 0.23 #plogis(logitU)#0.23 # Amplitude of seasonality
w <- 0.91#plogis(logitW)#0.91 # Timing of peak growth
t_hatch <- 60/365 #((16+197)/2)/365 # time of hatching, Julian day / 365 - spawning from Jan. to May (a bit arbitrary from Hüssy et al., 2011), average set to peak spawning
VbgrF <- expression((-Linf)*exp(-k*(phi_t+age))+Linf)
times.i <- sort(unique(t[cohort.idx]))
times.i <- sort(unique(t))
times.i <- sort(unique(t_mean))
times.i
times.i <- sort(unique(t_mean))
for(j in 1:length(times.i)){
mean_idx <- which(t_mean==times.i[j] & cohort_mean==cohorts[i])
age.j <- times.i[j]-t_hatch
phi_t.j <- u*sin(2*pi*(times.i[j]-w))/(2*pi) # seasonal variability in growth
weight_m <- sqrt(n_mean[mean_idx])
L.pred <- eval(VbgrF,list(age=age.j,k=k[i],Linf=Linf[i],
phi_t =phi_t.j))
ret <- ret-dnorm(L_mean[mean_idx],mean=L.pred,sd=SD_m,log=TRUE)*weight_m # fit mean length
}
ret <- 0
times.i <- sort(unique(t_mean))
for(j in 1:length(times.i)){
mean_idx <- which(t_mean==times.i[j])
age.j <- times.i[j]-t_hatch
phi_t.j <- u*sin(2*pi*(times.i[j]-w))/(2*pi) # seasonal variability in growth
weight_m <- sqrt(n_mean[mean_idx])
L.pred <- eval(VbgrF,list(age=age.j,k=k[i],Linf=Linf[i],
phi_t =phi_t.j))
ret <- ret-dnorm(L_mean[mean_idx],mean=L.pred,sd=SD_m,log=TRUE)*weight_m # fit mean length
}
ret <- 0
times.i <- sort(unique(t_mean))
for(j in 1:length(times.i)){
mean_idx <- which(t_mean==times.i[j])
age.j <- times.i[j]-t_hatch
phi_t.j <- u*sin(2*pi*(times.i[j]-w))/(2*pi) # seasonal variability in growth
weight_m <- sqrt(n_mean[mean_idx])
L.pred <- eval(VbgrF,list(age=age.j,k=k,Linf=Linf,
phi_t =phi_t.j))
ret <- ret-dnorm(L_mean[mean_idx],mean=L.pred,sd=SD_m,log=TRUE)*weight_m # fit mean length
}
ret
rm(list=setdiff(ls(),c('dat','ca_cod','larvae','cod')))
df_m <- data.frame(t_mean = rep(ca_cod$t,times=round(ca_cod$HLNoAtLngt)),
L_mean = rep(ca_cod$Length,times=round(ca_cod$HLNoAtLngt)),
cohort_mean = rep(ca_cod$cohort,times=round(ca_cod$HLNoAtLngt)),
n_mean = 1)
df_mean <- aggregate(L_mean~t_mean+cohort_mean,data=df_m %>% filter(cohort_mean==2001),FUN=mean)
df_mean$n_mean <- aggregate(n_mean~t_mean+cohort_mean,data=df_m %>% filter(cohort_mean==2001),FUN=sum)$n_mean
#%>% filter(Age>0))
#rm(list=setdiff(ls(),c('par','dat')))
dat <- as.list(df_mean)
par <- list()
par$logK.1 <- log(0.3)
par$logLinf.1 <- log(70)
par$logSD_m <- -1 # deviation from mean fit
f <- function(par){
getAll(par,dat)
k <- c(exp(logK.1))#,exp(logK.rand))
Linf <- c(exp(logLinf.1))#,exp(logLinf.rand))
SD_m <- exp(logSD_m)
u <- 0.23 #plogis(logitU)#0.23 # Amplitude of seasonality
w <- 0.91#plogis(logitW)#0.91 # Timing of peak growth
t_hatch <- 60/365 #((16+197)/2)/365 # time of hatching, Julian day / 365 - spawning from Jan. to May (a bit arbitrary from Hüssy et al., 2011), average set to peak spawning
VbgrF <- expression((-Linf)*exp(-k*(phi_t+age))+Linf)
ret <- 0
times.i <- sort(unique(t_mean))
for(j in 1:length(times.i)){
mean_idx <- which(t_mean==times.i[j])
age.j <- times.i[j]-t_hatch
phi_t.j <- u*sin(2*pi*(times.i[j]-w))/(2*pi) # seasonal variability in growth
weight_m <- sqrt(n_mean[mean_idx])
L.pred <- eval(VbgrF,list(age=age.j,k=k,Linf=Linf,
phi_t =phi_t.j))
ret <- ret-dnorm(L_mean[mean_idx],mean=L.pred,sd=SD_m,log=TRUE)*weight_m # fit mean length
}
L_mean <- OBS(L_mean)
t_mean <- OBS(t_mean)
cohort_mean <- OBS(cohort_mean)
n_mean <- OBS(n_mean)
ret
}
obj <- MakeADFun(f,par,silent=TRUE)
obj$env$obs
opt <- nlminb(obj$par, obj$fn, obj$gr)
sdr <- sdreport(obj)
sdr
f <- function(par){
getAll(par,dat)
k <- c(exp(logK.1))#,exp(logK.rand))
Linf <- c(exp(logLinf.1))#,exp(logLinf.rand))
SD_m <- exp(logSD_m)
u <- 0.23 #plogis(logitU)#0.23 # Amplitude of seasonality
w <- 0.91#plogis(logitW)#0.91 # Timing of peak growth
t_hatch <- 60/365 #((16+197)/2)/365 # time of hatching, Julian day / 365 - spawning from Jan. to May (a bit arbitrary from Hüssy et al., 2011), average set to peak spawning
VbgrF <- expression((-Linf)*exp(-k*(phi_t+age))+Linf)
ret <- 0
times.i <- sort(unique(t_mean))
for(j in 1:length(times.i)){
mean_idx <- which(t_mean==times.i[j])
age.j <- times.i[j]-t_hatch
phi_t.j <- u*sin(2*pi*(times.i[j]-w))/(2*pi) # seasonal variability in growth
weight_m <- sqrt(n_mean[mean_idx])
L.pred <- eval(VbgrF,list(age=age.j,k=k,Linf=Linf,
phi_t =phi_t.j))
ret <- ret-dnorm(log(L_mean[mean_idx]),mean=log(L.pred),sd=SD_m,log=TRUE)*weight_m # fit mean length
}
L_mean <- OBS(L_mean)
t_mean <- OBS(t_mean)
cohort_mean <- OBS(cohort_mean)
n_mean <- OBS(n_mean)
ret
}
obj <- MakeADFun(f,par,silent=TRUE)
obj$env$obs
opt <- nlminb(obj$par, obj$fn, obj$gr)
sdr <- sdreport(obj)
sdr
res <- oneStepPredict(obj)
head(res)
f <- function(par){
getAll(par,dat)
k <- c(exp(logK.1))#,exp(logK.rand))
Linf <- c(exp(logLinf.1))#,exp(logLinf.rand))
SD_m <- exp(logSD_m)
u <- 0.23 #plogis(logitU)#0.23 # Amplitude of seasonality
w <- 0.91#plogis(logitW)#0.91 # Timing of peak growth
t_hatch <- 60/365 #((16+197)/2)/365 # time of hatching, Julian day / 365 - spawning from Jan. to May (a bit arbitrary from Hüssy et al., 2011), average set to peak spawning
VbgrF <- expression((-Linf)*exp(-k*(phi_t+age))+Linf)
ret <- 0
times.i <- sort(unique(t_mean))
L_mean <- OBS(L_mean)
t_mean <- OBS(t_mean)
cohort_mean <- OBS(cohort_mean)
n_mean <- OBS(n_mean)
for(j in 1:length(times.i)){
mean_idx <- which(t_mean==times.i[j])
age.j <- times.i[j]-t_hatch
phi_t.j <- u*sin(2*pi*(times.i[j]-w))/(2*pi) # seasonal variability in growth
weight_m <- sqrt(n_mean[mean_idx])
L.pred <- eval(VbgrF,list(age=age.j,k=k,Linf=Linf,
phi_t =phi_t.j))
ret <- ret-dnorm(log(L_mean[mean_idx]),mean=log(L.pred),sd=SD_m,log=TRUE)*weight_m # fit mean length
}
ret
}
obj <- MakeADFun(f,par,silent=TRUE)
obj$env$obs
opt <- nlminb(obj$par, obj$fn, obj$gr)
sdr <- sdreport(obj)
sdr
res <- oneStepPredict(obj)
getAll(par,dat)
k <- c(exp(logK.1))#,exp(logK.rand))
Linf <- c(exp(logLinf.1))#,exp(logLinf.rand))
SD_m <- exp(logSD_m)
u <- 0.23 #plogis(logitU)#0.23 # Amplitude of seasonality
w <- 0.91#plogis(logitW)#0.91 # Timing of peak growth
t_hatch <- 60/365 #((16+197)/2)/365 # time of hatching, Julian day / 365 - spawning from Jan. to May (a bit arbitrary from Hüssy et al., 2011), average set to peak spawning
VbgrF <- expression((-Linf)*exp(-k*(phi_t+age))+Linf)
times.i <- sort(unique(t_mean))
L.pred <- rep(NA,length(times.i))
for(j in 1:length(times.i)){
age.j <- times.i[j]-t_hatch
phi_t.j <- u*sin(2*pi*(times.i[j]-w))/(2*pi) # seasonal variability in growth
L.pred[i] <- eval(VbgrF,list(age=age.j,k=k,Linf=Linf,
phi_t =phi_t.j))
}
L.pred <- rep(NA,length(times.i))
for(j in 1:length(times.i)){
age.j <- times.i[j]-t_hatch
phi_t.j <- u*sin(2*pi*(times.i[j]-w))/(2*pi) # seasonal variability in growth
L.pred[j] <- eval(VbgrF,list(age=age.j,k=k,Linf=Linf,
phi_t =phi_t.j))
}
L.pred
weight_m <- sqrt(n_mean)
ret <- -sum(dnorm(log(L_mean),mean=log(L.pred),sd=SD_m,log=TRUE)*weight_m) # fit mean length
ret
f <- function(par){
getAll(par,dat)
k <- c(exp(logK.1))#,exp(logK.rand))
Linf <- c(exp(logLinf.1))#,exp(logLinf.rand))
SD_m <- exp(logSD_m)
u <- 0.23 #plogis(logitU)#0.23 # Amplitude of seasonality
w <- 0.91#plogis(logitW)#0.91 # Timing of peak growth
t_hatch <- 60/365 #((16+197)/2)/365 # time of hatching, Julian day / 365 - spawning from Jan. to May (a bit arbitrary from Hüssy et al., 2011), average set to peak spawning
VbgrF <- expression((-Linf)*exp(-k*(phi_t+age))+Linf)
times.i <- sort(unique(t_mean))
L.pred <- rep(NA,length(times.i))
for(j in 1:length(times.i)){
age.j <- times.i[j]-t_hatch
phi_t.j <- u*sin(2*pi*(times.i[j]-w))/(2*pi) # seasonal variability in growth
L.pred[j] <- eval(VbgrF,list(age=age.j,k=k,Linf=Linf,
phi_t =phi_t.j))
}
weight_m <- sqrt(n_mean)
L_mean <- OBS(L_mean)
t_mean <- OBS(t_mean)
cohort_mean <- OBS(cohort_mean)
n_mean <- OBS(n_mean)
ret <- -sum(dnorm(log(L_mean),mean=log(L.pred),sd=SD_m,log=TRUE)*weight_m) # fit mean length
ret
}
obj <- MakeADFun(f,par,silent=TRUE)
getAll(par,dat)
k <- c(exp(logK.1))#,exp(logK.rand))
Linf <- c(exp(logLinf.1))#,exp(logLinf.rand))
SD_m <- exp(logSD_m)
u <- 0.23 #plogis(logitU)#0.23 # Amplitude of seasonality
w <- 0.91#plogis(logitW)#0.91 # Timing of peak growth
t_hatch <- 60/365 #((16+197)/2)/365 # time of hatching, Julian day / 365 - spawning from Jan. to May (a bit arbitrary from Hüssy et al., 2011), average set to peak spawning
VbgrF <- expression((-Linf)*exp(-k*(phi_t+age))+Linf)
times.i <- sort(unique(t_mean))
L.pred <- rep(NA,length(times.i))
for(j in 1:length(times.i)){
age.j <- times.i[j]-t_hatch
phi_t.j <- u*sin(2*pi*(times.i[j]-w))/(2*pi) # seasonal variability in growth
L.pred[j] <- eval(VbgrF,list(age=age.j,k=k,Linf=Linf,
phi_t =phi_t.j))
}
weight_m <- sqrt(n_mean)
L_mean <- OBS(L_mean)
t_mean <- OBS(t_mean)
cohort_mean <- OBS(cohort_mean)
n_mean <- OBS(n_mean)
ret <- -sum(dnorm(log(L_mean),mean=log(L.pred),sd=SD_m,log=TRUE)*weight_m) # fit mean length
ret
f <- function(par){
getAll(par,dat)
k <- c(exp(logK.1))#,exp(logK.rand))
Linf <- c(exp(logLinf.1))#,exp(logLinf.rand))
SD_m <- exp(logSD_m)
u <- 0.23 #plogis(logitU)#0.23 # Amplitude of seasonality
w <- 0.91#plogis(logitW)#0.91 # Timing of peak growth
t_hatch <- 60/365 #((16+197)/2)/365 # time of hatching, Julian day / 365 - spawning from Jan. to May (a bit arbitrary from Hüssy et al., 2011), average set to peak spawning
VbgrF <- expression((-Linf)*exp(-k*(phi_t+age))+Linf)
times.i <- sort(unique(t_mean))
L.pred <- rep(NA,length(times.i))
for(j in 1:length(times.i)){
age.j <- times.i[j]-t_hatch
phi_t.j <- u*sin(2*pi*(times.i[j]-w))/(2*pi) # seasonal variability in growth
L.pred[j] <- eval(VbgrF,list(age=age.j,k=k,Linf=Linf,
phi_t =phi_t.j))
}
weight_m <- sqrt(n_mean)
L_mean <- OBS(L_mean)
t_mean <- OBS(t_mean)
cohort_mean <- OBS(cohort_mean)
n_mean <- OBS(n_mean)
ret <- -sum(dnorm(log(L_mean),mean=log(L.pred),sd=SD_m,log=TRUE)*weight_m) # fit mean length
ret
}
obj <- MakeADFun(f,par,silent=TRUE)
f <- function(par){
getAll(par,dat)
k <- c(exp(logK.1))#,exp(logK.rand))
Linf <- c(exp(logLinf.1))#,exp(logLinf.rand))
SD_m <- exp(logSD_m)
u <- 0.23 #plogis(logitU)#0.23 # Amplitude of seasonality
w <- 0.91#plogis(logitW)#0.91 # Timing of peak growth
t_hatch <- 60/365 #((16+197)/2)/365 # time of hatching, Julian day / 365 - spawning from Jan. to May (a bit arbitrary from Hüssy et al., 2011), average set to peak spawning
VbgrF <- expression((-Linf)*exp(-k*(phi_t+age))+Linf)
times.i <- sort(unique(t_mean))
L.pred <- rep(NA,length(times.i))
for(j in 1:length(times.i)){
age.j <- times.i[j]-t_hatch
phi_t.j <- u*sin(2*pi*(times.i[j]-w))/(2*pi) # seasonal variability in growth
L.pred[j] <- eval(VbgrF,list(age=age.j,k=k,Linf=Linf,
phi_t =phi_t.j))
}
weight_m <- sqrt(n_mean)
L_mean <- OBS(L_mean)
t_mean <- OBS(t_mean)
cohort_mean <- OBS(cohort_mean)
n_mean <- OBS(n_mean)
ret <- -sum(dnorm((L_mean),mean=(L.pred),sd=SD_m,log=TRUE)*weight_m) # fit mean length
ret
}
obj <- MakeADFun(f,par,silent=TRUE)
rm(list=setdiff(ls(),c('dat','ca_cod','larvae','cod')))
df_m <- data.frame(t_mean = rep(ca_cod$t,times=round(ca_cod$HLNoAtLngt)),
L_mean = rep(ca_cod$Length,times=round(ca_cod$HLNoAtLngt)),
cohort_mean = rep(ca_cod$cohort,times=round(ca_cod$HLNoAtLngt)),
n_mean = 1)
df_mean <- aggregate(L_mean~t_mean+cohort_mean,data=df_m %>% filter(cohort_mean==2001),FUN=mean)
df_mean$n_mean <- aggregate(n_mean~t_mean+cohort_mean,data=df_m %>% filter(cohort_mean==2001),FUN=sum)$n_mean
#%>% filter(Age>0))
#rm(list=setdiff(ls(),c('par','dat')))
dat <- as.list(df_mean)
par <- list()
par$logK.1 <- log(0.3)
par$logLinf.1 <- log(70)
par$logSD_m <- -1 # deviation from mean fit
getAll(par,dat)
k <- c(exp(logK.1))#,exp(logK.rand))
Linf <- c(exp(logLinf.1))#,exp(logLinf.rand))
SD_m <- exp(logSD_m)
u <- 0.23 #plogis(logitU)#0.23 # Amplitude of seasonality
w <- 0.91#plogis(logitW)#0.91 # Timing of peak growth
t_hatch <- 60/365 #((16+197)/2)/365 # time of hatching, Julian day / 365 - spawning from Jan. to May (a bit arbitrary from Hüssy et al., 2011), average set to peak spawning
VbgrF <- expression((-Linf)*exp(-k*(phi_t+age))+Linf)
times.i <- sort(unique(t_mean))
L.pred <- rep(NA,length(times.i))
for(j in 1:length(times.i)){
age.j <- times.i[j]-t_hatch
phi_t.j <- u*sin(2*pi*(times.i[j]-w))/(2*pi) # seasonal variability in growth
L.pred[j] <- eval(VbgrF,list(age=age.j,k=k,Linf=Linf,
phi_t =phi_t.j))
}
weight_m <- sqrt(n_mean)
L_mean <- OBS(L_mean)
t_mean <- OBS(t_mean)
cohort_mean <- OBS(cohort_mean)
n_mean <- OBS(n_mean)
ret <- -sum(dnorm(log(L_mean),mean=log(L.pred),sd=SD_m,log=TRUE)*weight_m) # fit mean length
ret
f <- function(par){
getAll(par,dat)
k <- c(exp(logK.1))#,exp(logK.rand))
Linf <- c(exp(logLinf.1))#,exp(logLinf.rand))
SD_m <- exp(logSD_m)
u <- 0.23 #plogis(logitU)#0.23 # Amplitude of seasonality
w <- 0.91#plogis(logitW)#0.91 # Timing of peak growth
t_hatch <- 60/365 #((16+197)/2)/365 # time of hatching, Julian day / 365 - spawning from Jan. to May (a bit arbitrary from Hüssy et al., 2011), average set to peak spawning
VbgrF <- expression((-Linf)*exp(-k*(phi_t+age))+Linf)
times.i <- sort(unique(t_mean))
L.pred <- rep(NA,length(times.i))
for(j in 1:length(times.i)){
age.j <- times.i[j]-t_hatch
phi_t.j <- u*sin(2*pi*(times.i[j]-w))/(2*pi) # seasonal variability in growth
L.pred[j] <- eval(VbgrF,list(age=age.j,k=k,Linf=Linf,
phi_t =phi_t.j))
}
weight_m <- sqrt(n_mean)
L_mean <- OBS(L_mean)
t_mean <- OBS(t_mean)
cohort_mean <- OBS(cohort_mean)
n_mean <- OBS(n_mean)
ret <- -sum(dnorm(log(L_mean),mean=log(L.pred),sd=SD_m,log=TRUE)*weight_m) # fit mean length
ret
}
obj <- MakeADFun(f,par,silent=TRUE)
getAll(par,dat)
k <- c(exp(logK.1))#,exp(logK.rand))
Linf <- c(exp(logLinf.1))#,exp(logLinf.rand))
SD_m <- exp(logSD_m)
u <- 0.23 #plogis(logitU)#0.23 # Amplitude of seasonality
w <- 0.91#plogis(logitW)#0.91 # Timing of peak growth
t_hatch <- 60/365 #((16+197)/2)/365 # time of hatching, Julian day / 365 - spawning from Jan. to May (a bit arbitrary from Hüssy et al., 2011), average set to peak spawning
VbgrF <- expression((-Linf)*exp(-k*(phi_t+age))+Linf)
times.i <- sort(unique(t_mean))
L.pred <- rep(NA,length(times.i))
for(j in 1:length(times.i)){
age.j <- times.i[j]-t_hatch
phi_t.j <- u*sin(2*pi*(times.i[j]-w))/(2*pi) # seasonal variability in growth
L.pred[j] <- eval(VbgrF,list(age=age.j,k=k,Linf=Linf,
phi_t =phi_t.j))
}
weight_m <- sqrt(n_mean)
L_mean <- OBS(L_mean)
t_mean <- OBS(t_mean)
cohort_mean <- OBS(cohort_mean)
n_mean <- OBS(n_mean)
ret <- -sum(dnorm((L_mean),mean=(L.pred),sd=SD_m,log=TRUE)*weight_m) # fit mean length
ret
f <- function(par){
getAll(par,dat)
k <- c(exp(logK.1))#,exp(logK.rand))
Linf <- c(exp(logLinf.1))#,exp(logLinf.rand))
SD_m <- exp(logSD_m)
u <- 0.23 #plogis(logitU)#0.23 # Amplitude of seasonality
w <- 0.91#plogis(logitW)#0.91 # Timing of peak growth
t_hatch <- 60/365 #((16+197)/2)/365 # time of hatching, Julian day / 365 - spawning from Jan. to May (a bit arbitrary from Hüssy et al., 2011), average set to peak spawning
VbgrF <- expression((-Linf)*exp(-k*(phi_t+age))+Linf)
times.i <- sort(unique(t_mean))
L.pred <- rep(NA,length(times.i))
for(j in 1:length(times.i)){
age.j <- times.i[j]-t_hatch
phi_t.j <- u*sin(2*pi*(times.i[j]-w))/(2*pi) # seasonal variability in growth
L.pred[j] <- eval(VbgrF,list(age=age.j,k=k,Linf=Linf,
phi_t =phi_t.j))
}
#weight_m <- sqrt(n_mean)
#L_mean <- OBS(L_mean)
#t_mean <- OBS(t_mean)
#cohort_mean <- OBS(cohort_mean)
#n_mean <- OBS(n_mean)
ret <- -sum(dnorm((L_mean),mean=(L.pred),sd=SD_m,log=TRUE)*weight_m) # fit mean length
ret
}
obj <- MakeADFun(f,par,silent=TRUE)
L.pred
L_mean
SD_m
weight_m
dnorm((L_mean),mean=(L.pred),sd=SD_m,log=TRUE)
sum(dnorm((L_mean),mean=(L.pred),sd=SD_m,log=TRUE)*weight_m)
f <- function(par){
getAll(par,dat)
k <- c(exp(logK.1))#,exp(logK.rand))
Linf <- c(exp(logLinf.1))#,exp(logLinf.rand))
SD_m <- exp(logSD_m)
u <- 0.23 #plogis(logitU)#0.23 # Amplitude of seasonality
w <- 0.91#plogis(logitW)#0.91 # Timing of peak growth
t_hatch <- 60/365 #((16+197)/2)/365 # time of hatching, Julian day / 365 - spawning from Jan. to May (a bit arbitrary from Hüssy et al., 2011), average set to peak spawning
VbgrF <- expression((-Linf)*exp(-k*(phi_t+age))+Linf)
times.i <- sort(unique(t_mean))
L.pred <- rep(NA,length(times.i))
for(j in 1:length(times.i)){
age.j <- times.i[j]-t_hatch
phi_t.j <- u*sin(2*pi*(times.i[j]-w))/(2*pi) # seasonal variability in growth
L.pred[j] <- eval(VbgrF,list(age=age.j,k=k,Linf=Linf,
phi_t =phi_t.j))
}
weight_m <- sqrt(n_mean)
#L_mean <- OBS(L_mean)
#t_mean <- OBS(t_mean)
#cohort_mean <- OBS(cohort_mean)
#n_mean <- OBS(n_mean)
ret <- -sum(dnorm((L_mean),mean=(L.pred),sd=SD_m,log=TRUE)*weight_m) # fit mean length
ret
}
obj <- MakeADFun(f,par,silent=TRUE)
weight_m
