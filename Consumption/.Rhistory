library(ggplot2)
library(dplyr)
library(egg)
library(smsR)
# read in functions from other scripts
source('getPredators.R')
setwd("~/GitHub/SOS_FISK/Consumption")
# packages required
library(ggplot2)
library(dplyr)
library(egg)
library(smsR)
# read in functions from other scripts
source('getPredators.R')
source('getDiets.R')
source('getEnergyBudget.R')
source('getConsumption.R')
source('getConsPlot.R')
source('getDietPlot.R')
source('getM_&_F.R')
# predator abundance
Predators <- getPredators(years = 1991:2023,species = c('cormorant','grey seal'))
# predator diets
Diets <- getDiets(Predators,method='data') # select always 'data' for now
# how much fish (g) the predators eat of selected prey fish
g_eaten <- getEnergyBudget(Diets,method='model')
# the total consumption (tonnes) of selected prey fish by the predators
consumption <- getConsumption(g_eaten,Predators)
# plot the consumption compared to the fishery
getConsPlot(prey='cod',consumption,type="total")
# plot the diets
getDietPlot(predators=c('cormorant','grey seal'),Diets,year=c(1993)) # this is weight-based diets and n denote number of excrements
# plot mortality
getMortality(consumption)
setwd("~/GitHub/SOS_FISK/Dirichlet diet estimation")
# Load preference functions
load("preference functions/seal_cod_pref.RData")
load("preference functions/seal_herring_pref.RData")
load("preference functions/seal_flatfish_pref.RData")
load("preference functions/corm_cod_pref.RData")
load("preference functions/corm_herring_pref.RData")
load("preference functions/corm_flatfish_pref.RData")
data_wd <- paste(dirname(dirname(getwd())),"/SOS data/",sep="")
coefs <- readRDS(paste(data_wd,"coefficients.R",sep=""))
# Define cod functions and read data
#####
# Growth model, cohort spread by length, and individuals at by age and time, functions: vbgr.fixed(), vbgr.sd(), N_age
vbgrCod <- function(age,cohort){ # von Bertalanffy growth rate. Parameters from McQueen et al., 2019 with fixed hatching time
if(cohort>max(coefs$cod_varying_growth$cohort)) cohort <- max(coefs$cod_varying_growth$cohort)
if(cohort<min(coefs$cod_varying_growth$cohort)) cohort <- min(coefs$cod_varying_growth$cohort)
# define growth parameters
Linf <- coefs$cod_varying_growth$Linf[coefs$cod_varying_growth$cohort %in% cohort] # cm. McQueen et al., 2019
L_hatch <- coefs$L_hatch_cod # length at hatching, cm (Pepin et al, 1997)
k <- coefs$cod_varying_growth$k[coefs$cod_varying_growth$cohort %in% cohort] # vbgr growth rate, from McQueen
u <- coefs$u # Amplitude of seasonality
w <- coefs$w # Timing of peak growth
t_hatch <- coefs$t_hatch_cod # time of hatching, Julian day / 365 - spawning from Jan. to July (a bit arbitrary from Hüssy et al., 2011), average set to peak spawning
t <- age+t_hatch
X_t <- t-floor(t) # time of year [0,1]
phi_t <- u*sin(2*pi*(X_t-w))/(2*pi) # seasonal variability in growth
phi_hatch <- u*sin(2*pi*(t_hatch-w))/(2*pi) # seasonal variability in growth
L_t <- (L_hatch-Linf)*exp(-k*(phi_t+age-phi_hatch))+Linf # vbgr estimated length
return(L_t)
}
vbgr.sdCod <- function(age,cohort,n){ # von Bertalanffy growth rate. Parameters from McQueen et al., 2019 and estimated
if(cohort>max(coefs$cod_varying_growth$cohort)) cohort <- max(coefs$cod_varying_growth$cohort)
if(cohort<min(coefs$cod_varying_growth$cohort)) cohort <- min(coefs$cod_varying_growth$cohort)
# t in fraction year, Julian day/365
Linf <- rnorm(n,mean=coefs$cod_varying_growth$Linf[coefs$cod_varying_growth$cohort %in% cohort],
sd=coefs$cod_varying_sd$Linf_sd[coefs$cod_varying_sd$cohort==cohort]) # Assymptotic length - with stochasticity
L_hatch <- coefs$L_hatch_cod # length at hatching, cm (Pepin et al, 1997)
k <- rnorm(n,mean=coefs$cod_varying_growth$k[coefs$cod_varying_growth$cohort %in% cohort],
sd=coefs$cod_varying_sd$k_sd[coefs$cod_varying_sd$cohort==cohort])# vbgr growth rate
u <- coefs$u # Amplitude of seasonality
w <- coefs$w # Timing of peak growth
t_hatch <- coefs$t_hatch_cod # time of hatching, Julian day / 365 - spawning from Jan. to July (a bit arbitrary from Hüssy et al., 2011), average set to peak spawning
t <- age+t_hatch
X_t <- t-floor(t) # time of year [0,1]
phi_t <- u*sin(2*pi*(X_t-w))/(2*pi) # seasonal variability in growth
phi_hatch <- u*sin(2*pi*(t_hatch-w))/(2*pi) # seasonal variability in growth
sd <- rep(0,length(t))
for (i in 1:length(sd)){
fish.age <- age[i]+rnorm(n,mean=0,
sd=coefs$cod_varying_sd$A_sd[coefs$cod_varying_sd$cohort==cohort]) # time of hatching with stochasticity, Julian day / 365 - mean = march 1st
L_t <- (L_hatch-Linf)*exp(-k*(phi_t[i]+fish.age-phi_hatch))+Linf # vbgr estimated length
sd[i] <- sd(L_t)
}
return(sd)
}
N_ageCod <- function(dat,age,yrs){ # Number of individuals by age
dat$Z <- dat$M_var+dat$Fest
Ns <- matrix(rep(0,(length(age)+1)*length(yrs)*365),ncol = length(age)+1)
Ns[,length(age)+1] <- rep(yrs,each=365)
x <- seq(1/365,1,length=365)
for(i in 1:length(yrs)){
for(j in 1:length(age)){
di <- dat %>% filter(ages==age[j] & years==yrs[i])
dip1 <- dat %>% filter(ages==(age[j]+1) & years==(yrs[i]+1))
Ns[(365*(i-1)+1):(365*i),j] <- di$N*exp(-x*di$Z)
}
}
return(Ns)
}
Cod <- read.table(paste(data_wd,'M_sms.csv',sep=""),sep=';',header=TRUE)
View(Cod)
Cod$cor <- Cod$years-Cod$ages
c16 <- Cod %>% filter(cor==2016'')
c16 <- Cod %>% filter(cor==2016)
View(c16)
View(Cod)
plot(log(c16$N))
lm(log(N)~years,data=c16)
setwd("~/GitHub/SOS_FISK/Consumption")
# packages required
library(ggplot2)
library(dplyr)
library(egg)
library(smsR)
# read in functions from other scripts
source('getPredators.R')
source('getDiets.R')
source('getEnergyBudget.R')
source('getConsumption.R')
source('getConsPlot.R')
source('getDietPlot.R')
source('getM_&_F.R')
# predator abundance
Predators <- getPredators(years = 1991:2023,species = c('cormorant','grey seal'))
# predator diets
Diets <- getDiets(Predators,method='data') # select always 'data' for now
# how much fish (g) the predators eat of selected prey fish
g_eaten <- getEnergyBudget(Diets,method='model')
# the total consumption (tonnes) of selected prey fish by the predators
consumption <- getConsumption(g_eaten,Predators)
# plot the consumption compared to the fishery
getConsPlot(prey='cod',consumption,type="total")
# plot mortality
getMortality(consumption)
data_wd <- "C:/Users/mavast/Documents/GitHub/SOS data/"
rel_age <- readRDS(paste(data_wd,"pred_ages.R",sep=""))
N <- sms_nis$N %>% filter(years %in% ind.cons$year)
#stock assessment numbers
sms_nis <- readRDS(paste(data_wd,"sms_mortality.RDS",sep=""))
N <- sms_nis$N %>% filter(years %in% ind.cons$year)
N <- sms_nis$N
View(N)
View(sms_nis)
# Run the Wester baltic cod as an sms assessment using the sam input data
library(smsRdevel) # Development version of smsR
library(tidyverse)
wd <- "C:/Users/mavast/Documents/Github/SOS-FISK/"
wd.dat <- "C:/Users/mavast/Documents/Github/SOS-FISK/data/user3-WBCod2024/WBCod2024/data/"
dat.sam <- read.sam.data(wd.dat)
# Remove 2024 here (has no catch data )
dat.sam$Surveyobs <- dat.sam$Surveyobs[,1:39,]
sam.dat <- load(file.path(wd, 'data/user3-WBCod2024/WBCod2024/run/data.Rdata'))
maxage <- max(as.numeric(colnames(dat$natMor)))
years <- 1985:2023
#dat <- GoR_data(file.path(wd,'data'), maxage, years) # Read the input data
# Some basic data to run the model
nyear <- length(years)
ages <- 0:maxage
nseason <- 1 # Number of seasons
Blim <- 16710.16 # From SMS
df.tmb <- get_TMB_parameters(
mtrx = dat.sam$mtrx, # List that contains M, mat, west, weca
Surveyobs = dat.sam$Surveyobs, # Survey observations (dimensions age, year, quarter, number of surveys)
Catchobs = dat.sam$Catchobs, # Catch observations  (dimensions age, year, quarter)
propM = dat.sam$mtrx$propM,
propF = dat.sam$mtrx$propF,
years = years, # Years to run
#endYear = 2020,
nseason = nseason, # Number of seasons
nsurvey = 3,
ages = ages, # Ages of the species
Fbarage = c(3,5), # Ages to calculate average fishing mortality (used for Fmsy calc)
Fminage = 1,
Fmaxage = 4, # Fully selected fishing mortality age
Qminage = c(0,1,0), # minimum age in surveys,
Qlastage = c(4,4,0),
Qmaxage = c(4,4,0),
leavesurveyout = c(1,1,1),
randomF = 0, # We run Fishing as a random effect
#effort = Feffort,
endFseason = 1, # which season does fishing stop in the final year of data
surveyStart =dat$sampleTimes[2:length(dat$sampleTimes)],
surveyEnd =  dat$sampleTimes[2:length(dat$sampleTimes)], # Does the survey last throughout the season it's conducted?
surveyCV =  list(c(0,1,2,3,4), c(1,2,3,4), c(0)),
catchCV = list(c(0,1,3)),
beta = Blim,
recmodel = 1, # Chose recruitment model (2 = estimated, hockey stick nll addition)
estCV = c(0,0,0),
nllfactor = c(1,1,.1) # Factor for relative strength of log-likelihood
)
parms <- getParms(df.tmb) # Standard smsR call to get the estimated parameters
mps <- getMPS(df.tmb,parms) # parameters in 'mps' are mapped, i.e., not estimated. Input value is used.
# NEED TO FIX ISPREDATOR == 0 ARRAY
sas <- runAssessment(df.tmb, parms, mps = mps, silent = TRUE)
plot(sas)
# Run the Wester baltic cod as an sms assessment using the sam input data
library(smsRdevel) # Development version of smsR
library(tidyverse)
wd <- "C:/Users/mavast/Documents/Github/SOS-FISK/"
wd.dat <- "C:/Users/mavast/Documents/Github/SOS-FISK/data/user3-WBCod2024/WBCod2024/data/"
#TMB::compile(file.path(wd,'src/smsRdevel.cpp')) # I am using a custom function based on smsR
dat.sam <- read.sam.data(wd.dat)
# Remove 2024 here (has no catch data )
dat.sam$Surveyobs <- dat.sam$Surveyobs[,1:40,]
sam.dat <- load(file.path(wd, 'data/user3-WBCod2024/WBCod2024/run/data.Rdata'))
maxage <- max(as.numeric(colnames(dat$natMor)))
years <- 1985:2024
#dat <- GoR_data(file.path(wd,'data'), maxage, years) # Read the input data
# Some basic data to run the model
nyear <- length(years)
ages <- 0:maxage
nseason <- 1 # Number of seasons
Blim <- 16710.16 # From SMS
df.tmb <- get_TMB_parameters(
mtrx = dat.sam$mtrx, # List that contains M, mat, west, weca
Surveyobs = dat.sam$Surveyobs, # Survey observations (dimensions age, year, quarter, number of surveys)
Catchobs = dat.sam$Catchobs, # Catch observations  (dimensions age, year, quarter)
propM = dat.sam$mtrx$propM,
propF = dat.sam$mtrx$propF,
years = years, # Years to run
#endYear = 2020,
nseason = nseason, # Number of seasons
nsurvey = 3,
ages = ages, # Ages of the species
Fbarage = c(3,5), # Ages to calculate average fishing mortality (used for Fmsy calc)
Fminage = 1,
Fmaxage = 4, # Fully selected fishing mortality age
Qminage = c(0,1,0), # minimum age in surveys,
Qlastage = c(4,4,0),
Qmaxage = c(4,4,0),
leavesurveyout = c(1,1,1),
randomF = 0, # We run Fishing as a random effect
#effort = Feffort,
endFseason = 1, # which season does fishing stop in the final year of data
surveyStart =dat$sampleTimes[2:length(dat$sampleTimes)],
surveyEnd =  dat$sampleTimes[2:length(dat$sampleTimes)], # Does the survey last throughout the season it's conducted?
surveyCV =  list(c(0,1,2,3,4), c(1,2,3,4), c(0)),
catchCV = list(c(0,1,3)),
beta = Blim,
recmodel = 1, # Chose recruitment model (2 = estimated, hockey stick nll addition)
estCV = c(0,0,0),
nllfactor = c(1,1,.1) # Factor for relative strength of log-likelihood
)
# Run the Wester baltic cod as an sms assessment using the sam input data
library(smsRdevel) # Development version of smsR
library(tidyverse)
wd <- "C:/Users/mavast/Documents/Github/SOS-FISK/"
wd.dat <- "C:/Users/mavast/Documents/Github/SOS-FISK/data/user3-WBCod2024/WBCod2024/data/"
#TMB::compile(file.path(wd,'src/smsRdevel.cpp')) # I am using a custom function based on smsR
dat.sam <- read.sam.data(wd.dat)
# Remove 2024 here (has no catch data )
dat.sam$Surveyobs <- dat.sam$Surveyobs[,1:40,]
sam.dat <- load(file.path(wd, 'data/user3-WBCod2024/WBCod2024/run/data.Rdata'))
maxage <- max(as.numeric(colnames(dat$natMor)))
years <- 1985:2024
#dat <- GoR_data(file.path(wd,'data'), maxage, years) # Read the input data
# Some basic data to run the model
nyear <- length(years)
ages <- 0:maxage
nseason <- 1 # Number of seasons
Blim <- 16710.16 # From SMS
df.tmb <- get_TMB_parameters(
mtrx = dat.sam$mtrx, # List that contains M, mat, west, weca
Surveyobs = dat.sam$Surveyobs, # Survey observations (dimensions age, year, quarter, number of surveys)
Catchobs = dat.sam$Catchobs, # Catch observations  (dimensions age, year, quarter)
propM = dat.sam$mtrx$propM,
propF = dat.sam$mtrx$propF,
years = years, # Years to run
#endYear = 2020,
nseason = nseason, # Number of seasons
nsurvey = 3,
ages = ages, # Ages of the species
Fbarage = c(3,5), # Ages to calculate average fishing mortality (used for Fmsy calc)
Fminage = 1,
Fmaxage = 4, # Fully selected fishing mortality age
Qminage = c(0,1,0), # minimum age in surveys,
Qlastage = c(4,4,0),
Qmaxage = c(4,4,0),
leavesurveyout = c(1,1,1),
randomF = 0, # We run Fishing as a random effect
#effort = Feffort,
endFseason = 1, # which season does fishing stop in the final year of data
surveyStart =dat$sampleTimes[2:length(dat$sampleTimes)],
surveyEnd =  dat$sampleTimes[2:length(dat$sampleTimes)], # Does the survey last throughout the season it's conducted?
surveyCV =  list(c(0,1,2,3,4), c(1,2,3,4), c(0)),
catchCV = list(c(0,1,3)),
beta = Blim,
recmodel = 1, # Chose recruitment model (2 = estimated, hockey stick nll addition)
estCV = c(0,0,0),
nllfactor = c(1,1,.1) # Factor for relative strength of log-likelihood
)
View(dat)
dat$years
# Run the Wester baltic cod as an sms assessment using the sam input data
library(smsRdevel) # Development version of smsR
library(tidyverse)
wd <- "C:/Users/mavast/Documents/Github/SOS-FISK/"
wd.dat <- "C:/Users/mavast/Documents/Github/SOS-FISK/data/user3-WBCod2024/WBCod2024/data/"
#TMB::compile(file.path(wd,'src/smsRdevel.cpp')) # I am using a custom function based on smsR
dat.sam <- read.sam.data(wd.dat)
# Remove 2024 here (has no catch data )
dat.sam$Surveyobs <- dat.sam$Surveyobs[,1:40,]
sam.dat <- load(file.path(wd, 'data/user3-WBCod2024/WBCod2024/run/data.Rdata'))
maxage <- max(as.numeric(colnames(dat$natMor)))
years <- 1985:2024
#dat <- GoR_data(file.path(wd,'data'), maxage, years) # Read the input data
# Some basic data to run the model
nyear <- length(years)
ages <- 0:maxage
nseason <- 1 # Number of seasons
# get_TMB_parameters prepares a list for the assessment model.
Blim <- 16710.16 # From SMS
df.tmb <- get_TMB_parameters(
mtrx = dat.sam$mtrx, # List that contains M, mat, west, weca
Surveyobs = dat.sam$Surveyobs, # Survey observations (dimensions age, year, quarter, number of surveys)
Catchobs = dat.sam$Catchobs, # Catch observations  (dimensions age, year, quarter)
propM = dat.sam$mtrx$propM,
propF = dat.sam$mtrx$propF,
years = years, # Years to run
#endYear = 2020,
nseason = nseason, # Number of seasons
nsurvey = 3,
ages = ages, # Ages of the species
Fbarage = c(3,5), # Ages to calculate average fishing mortality (used for Fmsy calc)
Fminage = 1,
Fmaxage = 4, # Fully selected fishing mortality age
Qminage = c(0,1,0), # minimum age in surveys,
Qlastage = c(4,4,0),
Qmaxage = c(4,4,0),
leavesurveyout = c(1,1,1),
randomF = 0, # We run Fishing as a random effect
#effort = Feffort,
endFseason = 1, # which season does fishing stop in the final year of data
surveyStart =dat$sampleTimes[2:length(dat$sampleTimes)],
surveyEnd =  dat$sampleTimes[2:length(dat$sampleTimes)], # Does the survey last throughout the season it's conducted?
surveyCV =  list(c(0,1,2,3,4), c(1,2,3,4), c(0)),
catchCV = list(c(0,1,3)),
beta = Blim,
recmodel = 1, # Chose recruitment model (2 = estimated, hockey stick nll addition)
estCV = c(0,0,0),
nllfactor = c(1,1,.1) # Factor for relative strength of log-likelihood
)
parms <- getParms(df.tmb) # Standard smsR call to get the estimated parameters
mps <- getMPS(df.tmb,parms) # parameters in 'mps' are mapped, i.e., not estimated. Input value is used.
# NEED TO FIX ISPREDATOR == 0 ARRAY
sas <- runAssessment(df.tmb, parms, mps = mps, silent = TRUE)
# Run the Wester baltic cod as an sms assessment using the sam input data
library(smsR) # Development version of smsR
library(tidyverse)
wd <- "C:/Users/mavast/Documents/Github/SOS-FISK/"
wd.dat <- "C:/Users/mavast/Documents/Github/SOS-FISK/data/user3-WBCod2024/WBCod2024/data/"
dat.sam <- read.sam.data(wd.dat)
# Remove 2024 here (has no catch data )
dat.sam$Surveyobs <- dat.sam$Surveyobs[,1:40,]
sam.dat <- load(file.path(wd, 'data/user3-WBCod2024/WBCod2024/run/data.Rdata'))
maxage <- max(as.numeric(colnames(dat$natMor)))
years <- 1985:2024
#dat <- GoR_data(file.path(wd,'data'), maxage, years) # Read the input data
# Some basic data to run the model
nyear <- length(years)
ages <- 0:maxage
nseason <- 1 # Number of seasons
Blim <- 16710.16 # From SMS
df.tmb <- get_TMB_parameters(
mtrx = dat.sam$mtrx, # List that contains M, mat, west, weca
Surveyobs = dat.sam$Surveyobs, # Survey observations (dimensions age, year, quarter, number of surveys)
Catchobs = dat.sam$Catchobs, # Catch observations  (dimensions age, year, quarter)
propM = dat.sam$mtrx$propM,
propF = dat.sam$mtrx$propF,
years = years, # Years to run
#endYear = 2020,
nseason = nseason, # Number of seasons
nsurvey = 3,
ages = ages, # Ages of the species
Fbarage = c(3,5), # Ages to calculate average fishing mortality (used for Fmsy calc)
Fminage = 1,
Fmaxage = 4, # Fully selected fishing mortality age
Qminage = c(0,1,0), # minimum age in surveys,
Qlastage = c(4,4,0),
Qmaxage = c(4,4,0),
leavesurveyout = c(1,1,1),
randomF = 0, # We run Fishing as a random effect
#effort = Feffort,
endFseason = 1, # which season does fishing stop in the final year of data
surveyStart =dat$sampleTimes[2:length(dat$sampleTimes)],
surveyEnd =  dat$sampleTimes[2:length(dat$sampleTimes)], # Does the survey last throughout the season it's conducted?
surveyCV =  list(c(0,1,2,3,4), c(1,2,3,4), c(0)),
catchCV = list(c(0,1,3)),
beta = Blim,
recmodel = 1, # Chose recruitment model (2 = estimated, hockey stick nll addition)
estCV = c(0,0,0),
nllfactor = c(1,1,.1) # Factor for relative strength of log-likelihood
)
View(dat)
# Run the Wester baltic cod as an sms assessment using the sam input data
library(smsRdevel) # Development version of smsR
library(tidyverse)
wd <- "C:/Users/mavast/Documents/Github/SOS-FISK/"
wd.dat <- "C:/Users/mavast/Documents/Github/SOS-FISK/data/user3-WBCod2024/WBCod2024/data/"
#TMB::compile(file.path(wd,'src/smsRdevel.cpp')) # I am using a custom function based on smsR
dat.sam <- read.sam.data(wd.dat)
# Remove 2024 here (has no catch data )
dat.sam$Surveyobs <- dat.sam$Surveyobs[,1:39,]
sam.dat <- load(file.path(wd, 'data/user3-WBCod2024/WBCod2024/run/data.Rdata'))
maxage <- max(as.numeric(colnames(dat$natMor)))
years <- 1985:2023
#dat <- GoR_data(file.path(wd,'data'), maxage, years) # Read the input data
# Some basic data to run the model
nyear <- length(years)
ages <- 0:maxage
nseason <- 1 # Number of seasons
# get_TMB_parameters prepares a list for the assessment model.
Blim <- 16710.16 # From SMS
df.tmb <- get_TMB_parameters(
mtrx = dat.sam$mtrx, # List that contains M, mat, west, weca
Surveyobs = dat.sam$Surveyobs, # Survey observations (dimensions age, year, quarter, number of surveys)
Catchobs = dat.sam$Catchobs, # Catch observations  (dimensions age, year, quarter)
propM = dat.sam$mtrx$propM,
propF = dat.sam$mtrx$propF,
years = years, # Years to run
#endYear = 2020,
nseason = nseason, # Number of seasons
nsurvey = 3,
ages = ages, # Ages of the species
Fbarage = c(3,5), # Ages to calculate average fishing mortality (used for Fmsy calc)
Fminage = 1,
Fmaxage = 4, # Fully selected fishing mortality age
Qminage = c(0,1,0), # minimum age in surveys,
Qlastage = c(4,4,0),
Qmaxage = c(4,4,0),
leavesurveyout = c(1,1,1),
randomF = 0, # We run Fishing as a random effect
#effort = Feffort,
endFseason = 1, # which season does fishing stop in the final year of data
surveyStart =dat$sampleTimes[2:length(dat$sampleTimes)],
surveyEnd =  dat$sampleTimes[2:length(dat$sampleTimes)], # Does the survey last throughout the season it's conducted?
surveyCV =  list(c(0,1,2,3,4), c(1,2,3,4), c(0)),
catchCV = list(c(0,1,3)),
beta = Blim,
recmodel = 1, # Chose recruitment model (2 = estimated, hockey stick nll addition)
estCV = c(0,0,0),
nllfactor = c(1,1,.1) # Factor for relative strength of log-likelihood
)
parms <- getParms(df.tmb) # Standard smsR call to get the estimated parameters
mps <- getMPS(df.tmb,parms) # parameters in 'mps' are mapped, i.e., not estimated. Input value is used.
# NEED TO FIX ISPREDATOR == 0 ARRAY
sas <- runAssessment(df.tmb, parms, mps = mps, silent = TRUE)
plot(sas)
#remotes::install_github("https://github.com/nissandjac/smsR", dependencies = TRUE)
#remotes::install_local("C:/Users/mavast/Desktop/Github/SOS-FISK/")
#credentials::set_github_pat("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")
# Run the Wester baltic cod as an sms assessment using the sam input data
library(smsR) # Development version of smsR
library(TMB)
library(tidyverse)
#detach("package:smsRdevel",unload=TRUE)
wd <- "C:/Users/mavast/Desktop/Github/SOS-FISK/"
wd.dat <- "C:/Users/mavast/Desktop/Github/SOS-FISK/data/user3-WBCod2025/WBCod2025/data/"
#TMB::compile(file.path(wd,'src/smsRdevel.cpp')) # I am using a custom function based on smsR
dat.sam <- read.sam.data(wd.dat)
# Remove 2024 here (has no catch data )
dat.sam$Surveyobs <- dat.sam$Surveyobs[,1:40,]
sam.dat <- load(file.path(wd, 'data/user3-WBCod2025/WBCod2025/run/data.Rdata'))
maxage <- max(as.numeric(colnames(dat$natMor)))
years <- 1985:2024
#dat <- GoR_data(file.path(wd,'data'), maxage, years) # Read the input data
# Some basic data to run the model
nyear <- length(years)
ages <- 0:maxage
nseason <- 1 # Number of seasons
# get_TMB_parameters prepares a list for the assessment model.
Blim <- 16710.16 # From SMS
df.tmb <- get_TMB_parameters(
mtrx = dat.sam$mtrx, # List that contains M, mat, west, weca
Surveyobs = dat.sam$Surveyobs, # Survey observations (dimensions age, year, quarter, number of surveys)
Catchobs = dat.sam$Catchobs, # Catch observations  (dimensions age, year, quarter)
propM = dat.sam$mtrx$propM,
propF = dat.sam$mtrx$propF,
years = years, # Years to run
nseason = nseason, # Number of seasons
nsurvey = 3,
ages = ages, # Ages of the species
Fbarage = c(3,5), # Ages to calculate average fishing mortality (used for Fmsy calc)
Fminage = 1,
Fmaxage = 4, # Fully selected fishing mortality age
Qminage = c(0,1,0), # minimum age in surveys,
Qlastage = c(4,4,0),
Qmaxage = c(4,4,0),
leavesurveyout = c(1,1,1),
randomF = 1, # We run Fishing as a random effect
randomM = 1, # Estimate M as a random effect,
randomR = 1,
Mprior = 2,
SDMprior = 0.1,
#effort = Feffort,
endFseason =  1, # which season does fishing stop in the final year of data
surveyStart =dat$sampleTimes[2:length(dat$sampleTimes)],
surveyEnd =  dat$sampleTimes[2:length(dat$sampleTimes)], # Does the survey last throughout the season it's conducted?
surveySD =  list(c(0,1,2,3,4), c(1,2,3,4), c(0)),
catchSD = list(c(0,1,3)),
MCV = c(0,2,4),
M_max = 6,
#Mprior = 0.01,
beta = Blim,
recmodel = 2, # Chose recruitment model (1 = estimated, 2 = deviations from mean, 3 Beverton holt with steepness
estSD = c(0,0,0),
nllfactor = c(1,1,1) # Factor for relative strength of log-likelihood
)
